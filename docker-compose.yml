version: '3.8'

# ============================================================
# THRYX: AI-Native Blockchain - Production Docker Stack
# ENHANCED with healthchecks, security agent, and intent processor
# Single command: docker-compose up --build
# ============================================================

services:
  # ==================== Core Chain (Anvil with Persistent State) ====================
  thryx-node:
    build:
      context: .
      dockerfile: Dockerfile.anvil
    container_name: thryx-node
    ports:
      - "0.0.0.0:8545:8545"
      - "0.0.0.0:8546:8546"
    volumes:
      - thryx-data:/app/data
    healthcheck:
      test: ["CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545"]
      interval: 2s
      timeout: 5s
      retries: 30
      start_period: 10s
    networks:
      - thryx-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G

  # ==================== Contract Deployment ====================
  deployer:
    build:
      context: .
      dockerfile: Dockerfile.deployer
    container_name: thryx-deployer
    depends_on:
      thryx-node:
        condition: service_healthy
    environment:
      - RPC_URL=http://thryx-node:8545
    volumes:
      - ./deployment.json:/app/deployment.json
    networks:
      - thryx-network

  # ==================== AI Agents ====================
  oracle-agent:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: thryx-oracle
    command: python -u oracle_agent.py
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - RPC_URL=http://thryx-node:8545
      - AGENT_MEMORY_FILE=/app/data/oracle_memory.json
    volumes:
      - ./deployment.json:/app/deployment.json:ro
      - agent-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.post('http://thryx-node:8545', json={'jsonrpc':'2.0','method':'eth_blockNumber','params':[],'id':1}, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - thryx-network
    deploy:
      resources:
        limits:
          memory: 512M

  arbitrage-agent:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: thryx-arbitrage
    command: python -u arbitrage_agent.py
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - RPC_URL=http://thryx-node:8545
      - AGENT_MEMORY_FILE=/app/data/arbitrage_memory.json
    volumes:
      - ./deployment.json:/app/deployment.json:ro
      - agent-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.post('http://thryx-node:8545', json={'jsonrpc':'2.0','method':'eth_blockNumber','params':[],'id':1}, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - thryx-network
    deploy:
      resources:
        limits:
          memory: 512M

  liquidity-agent:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: thryx-liquidity
    command: python -u liquidity_agent.py
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - RPC_URL=http://thryx-node:8545
      - AGENT_MEMORY_FILE=/app/data/liquidity_memory.json
    volumes:
      - ./deployment.json:/app/deployment.json:ro
      - agent-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.post('http://thryx-node:8545', json={'jsonrpc':'2.0','method':'eth_blockNumber','params':[],'id':1}, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - thryx-network
    deploy:
      resources:
        limits:
          memory: 512M

  governance-agent:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: thryx-governance
    command: python -u governance_agent.py
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - RPC_URL=http://thryx-node:8545
      - AGENT_MEMORY_FILE=/app/data/governance_memory.json
    volumes:
      - ./deployment.json:/app/deployment.json:ro
      - agent-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.post('http://thryx-node:8545', json={'jsonrpc':'2.0','method':'eth_blockNumber','params':[],'id':1}, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - thryx-network
    deploy:
      resources:
        limits:
          memory: 512M

  monitor-agent:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: thryx-monitor
    command: python -u monitor_agent.py
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - RPC_URL=http://thryx-node:8545
      - ENABLE_AUTO_REMEDIATION=true
    volumes:
      - ./deployment.json:/app/deployment.json:ro
      - agent-data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.post('http://thryx-node:8545', json={'jsonrpc':'2.0','method':'eth_blockNumber','params':[],'id':1}, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - thryx-network
    deploy:
      resources:
        limits:
          memory: 512M

  # ==================== Security Agent (NEW) ====================
  security-agent:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: thryx-security
    command: python -u security_agent.py
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - RPC_URL=http://thryx-node:8545
    volumes:
      - ./deployment.json:/app/deployment.json:ro
      - agent-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.post('http://thryx-node:8545', json={'jsonrpc':'2.0','method':'eth_blockNumber','params':[],'id':1}, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - thryx-network
    deploy:
      resources:
        limits:
          memory: 512M

  # ==================== Intent Processor Agent (NEW) ====================
  intent-agent:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: thryx-intent
    command: python -u intent_agent.py
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - RPC_URL=http://thryx-node:8545
      - AGENT_MEMORY_FILE=/app/data/intent_memory.json
    volumes:
      - ./deployment.json:/app/deployment.json:ro
      - agent-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.post('http://thryx-node:8545', json={'jsonrpc':'2.0','method':'eth_blockNumber','params':[],'id':1}, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - thryx-network
    deploy:
      resources:
        limits:
          memory: 512M

  # ==================== Base Bridge Agent ====================
  bridge-agent:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: thryx-bridge
    command: python -u bridge_agent.py
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - RPC_URL=http://thryx-node:8545
      - BASE_PRIVATE_KEY=${BASE_PRIVATE_KEY}
      - BRIDGE_STATE_FILE=/app/data/bridge_deposit_state.json
    volumes:
      - ./deployment.json:/app/deployment.json:ro
      - agent-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.post('http://thryx-node:8545', json={'jsonrpc':'2.0','method':'eth_blockNumber','params':[],'id':1}, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - thryx-network
    deploy:
      resources:
        limits:
          memory: 512M

  # ==================== Evolution Agent (Self-Learning AI) ====================
  evolution-agent:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: thryx-evolution
    command: python -u evolution_agent.py
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - RPC_URL=http://thryx-node:8545
      - EVOLUTION_MEMORY_FILE=/app/data/evolution_memory.json
    volumes:
      - ./deployment.json:/app/deployment.json:ro
      - agent-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.post('http://thryx-node:8545', json={'jsonrpc':'2.0','method':'eth_blockNumber','params':[],'id':1}, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - thryx-network
    deploy:
      resources:
        limits:
          memory: 512M

  # ==================== Market Maker Agent ====================
  market-maker-agent:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: thryx-market-maker
    command: python -u market_maker_agent.py
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - RPC_URL=http://thryx-node:8545
      - MM_STATE=/app/data/market_maker_state.json
    volumes:
      - ./deployment.json:/app/deployment.json:ro
      - agent-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.post('http://thryx-node:8545', json={'jsonrpc':'2.0','method':'eth_blockNumber','params':[],'id':1}, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - thryx-network
    deploy:
      resources:
        limits:
          memory: 512M

  # ==================== Airdrop Agent ====================
  airdrop-agent:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: thryx-airdrop
    command: python -u airdrop_agent.py
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - RPC_URL=http://thryx-node:8545
      - AIRDROP_STATE=/app/data/airdrop_state.json
    volumes:
      - ./deployment.json:/app/deployment.json:ro
      - agent-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.post('http://thryx-node:8545', json={'jsonrpc':'2.0','method':'eth_blockNumber','params':[],'id':1}, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - thryx-network
    deploy:
      resources:
        limits:
          memory: 512M

  # ==================== Social Engagement Agent ====================
  social-agent:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: thryx-social
    command: python -u social_agent.py
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - RPC_URL=http://thryx-node:8545
      - SOCIAL_STATE=/app/data/social_state.json
    volumes:
      - ./deployment.json:/app/deployment.json:ro
      - agent-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.post('http://thryx-node:8545', json={'jsonrpc':'2.0','method':'eth_blockNumber','params':[],'id':1}, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - thryx-network
    deploy:
      resources:
        limits:
          memory: 512M

  # ==================== Event Scheduler Agent ====================
  event-agent:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: thryx-event
    command: python -u event_agent.py
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - RPC_URL=http://thryx-node:8545
      - EVENT_STATE=/app/data/event_state.json
    volumes:
      - ./deployment.json:/app/deployment.json:ro
      - agent-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.post('http://thryx-node:8545', json={'jsonrpc':'2.0','method':'eth_blockNumber','params':[],'id':1}, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - thryx-network
    deploy:
      resources:
        limits:
          memory: 512M

  # ==================== Treasury Agent ====================
  treasury-agent:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: thryx-treasury
    command: python -u treasury_agent.py
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - RPC_URL=http://thryx-node:8545
      - TREASURY_STATE=/app/data/treasury_state.json
    volumes:
      - ./deployment.json:/app/deployment.json:ro
      - agent-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.post('http://thryx-node:8545', json={'jsonrpc':'2.0','method':'eth_blockNumber','params':[],'id':1}, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - thryx-network
    deploy:
      resources:
        limits:
          memory: 512M

  # ==================== Continuous Builder Agent (Always Building) ====================
  builder-agent:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: thryx-builder
    command: python -u continuous_builder.py
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - RPC_URL=http://thryx-node:8545
      - BUILDER_STATE=/app/data/builder_state.json
    volumes:
      - ./deployment.json:/app/deployment.json:ro
      - agent-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.post('http://thryx-node:8545', json={'jsonrpc':'2.0','method':'eth_blockNumber','params':[],'id':1}, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - thryx-network
    deploy:
      resources:
        limits:
          memory: 512M

  # ==================== Block Explorer ====================
  explorer:
    image: nginx:alpine
    container_name: thryx-explorer
    depends_on:
      thryx-node:
        condition: service_healthy
    volumes:
      - ./explorer/index.html:/usr/share/nginx/html/index.html:ro
      - ./explorer/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "0.0.0.0:5100:80"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - thryx-network
    restart: unless-stopped

networks:
  thryx-network:
    driver: bridge

volumes:
  thryx-data:
  agent-data:
