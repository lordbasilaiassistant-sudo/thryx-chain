name: Keep THRYX Alive

on:
  schedule:
    # Run every 20 minutes
    - cron: '*/20 * * * *'
  workflow_dispatch:

jobs:
  ping-thryx:
    runs-on: ubuntu-latest
    steps:
      - name: Ping THRYX RPC
        run: |
          echo "Pinging THRYX endpoints..."
          
          # Ping the RPC endpoint
          curl -s --max-time 60 -X POST \
            "https://crispy-goggles-v6jg77gvqwqv3pxpg-8545.app.github.dev" \
            -H "Content-Type: application/json" \
            -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
            || echo "RPC ping sent"
          
          # Ping the explorer
          curl -s --max-time 60 \
            "https://crispy-goggles-v6jg77gvqwqv3pxpg-5100.app.github.dev" \
            | head -c 200 || echo "Explorer ping sent"
          
          echo ""
          echo "THRYX keep-alive ping complete at $(date)"

      - name: Wake Codespace and Ensure Public Ports
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        if: env.GH_TOKEN != ''
        run: |
          CODESPACE="crispy-goggles-v6jg77gvqwqv3pxpg"
          
          STATE=$(gh codespace list --json name,state -q ".[] | select(.name==\"$CODESPACE\") | .state" 2>/dev/null || echo "unknown")
          echo "Codespace state: $STATE"
          
          if [ "$STATE" = "Shutdown" ]; then
            echo "Waking codespace..."
            gh codespace ssh -c "$CODESPACE" -- "cd /workspaces/thryx-chain && docker compose --env-file .env up -d" || echo "Wake attempt complete"
            sleep 30
          fi
          
          # Always ensure ports are public (they reset on restart)
          echo "Ensuring ports are public..."
          gh codespace ports visibility 8545:public 5100:public 3000:public -c "$CODESPACE" || echo "Port visibility set"
          
          # Verify containers are running
          gh codespace ssh -c "$CODESPACE" -- "docker ps --format '{{.Names}}: {{.Status}}' | head -5" || echo "Container check complete"
